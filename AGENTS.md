# Elearning — правила разработки (для Codex/агентов)

Этот файл описывает техстек, архитектурные договорённости и чеклисты качества. Цель — чтобы новые фичи добавлялись предсказуемо, читабельно и с покрытием бизнес‑логики тестами.

## Техстек
- Frontend: **Nuxt 4** (Vue 3), TypeScript, ESM.
- UI: **Vuetify 3** (`vite-plugin-vuetify`), `@mdi/font`.
- Редактор: **Quill** (`@vueup/vue-quill`).
- Backend: **Nuxt/Nitro** server routes на базе **h3** (`server/api/*`).
- Auth: **JWT** в httpOnly cookie (`server/utils/auth.ts`), `jsonwebtoken`, пароли — `bcryptjs`.
- DB: **PostgreSQL 16** (docker), **Prisma 7** + `@prisma/adapter-pg`.
- Файлы: локальное хранилище `./storage` (см. `STORAGE` в `.env`), загрузки через `busboy`.

## Быстрый старт (локально)
- Установить зависимости: `npm install`
- Поднять БД: `npm run docker:up`
- Запуск dev: `npm run dev` (по умолчанию `http://localhost:3000`)
- Prisma Studio: `npm run prisma:studio`
- Всё вместе: `npm run full`

Переменные окружения: `.env` (как минимум `DATABASE_URL`, `JWT_SECRET`, `STORAGE`).

## Структура проекта
- `pages/`, `layouts/`, `components/` — UI.
- `composables/` — клиентские/общие хелперы состояния и запросов.
- `plugins/` — подключение Vuetify, Quill и т.п.
- `utils/` — общие утилиты (shared, без побочных эффектов).
- `server/api/` — HTTP endpoints (тонкие контроллеры).
- `server/utils/` — общая серверная логика (db/auth/storage/…).
- `prisma/` — `schema.prisma`, миграции, `seed.ts`, `generated/` (генерируемый клиент).
- `scripts/` — служебные скрипты (например `scripts/server.sh` для запуска production build).

## Принципы кода (Clean Code + OOP/SOLID)
Ключевая идея: **контроллеры тонкие, бизнес‑логика отдельно, данные нормализованы, поведение тестируется**.

- **SRP**: один модуль/файл — одна ответственность (UI/контроллер/сервис/утилита).
- **Инварианты рядом с данными**: правила (например, нормализация цены/валюты, статусов, прав доступа) не размазывать по UI.
- **ООП по делу**: если логика имеет состояние/инварианты — допустимы классы/сервисы; если нет — предпочитайте чистые функции.
- **Типизация**: избегать `any`; входы — `unknown` + проверки; на выходе — явные DTO.
- **Читаемость**: маленькие функции, понятные имена, минимум вложенности, ранние `return/throw`.
- **Ошибки**: для HTTP — `createError({ statusCode, statusMessage })`; не возвращать stack traces/внутренности в ответе.
- **Безопасность по умолчанию**: не доверять входным данным, не отдавать лишние поля, не логировать секреты.

## Мини‑чеклист “чистого кода” (быстрая самопроверка)
- **SRP**: у файла/функции/класса одна причина измениться?
- **Зависимости**: бизнес‑логика не зависит от HTTP/DOM/Prisma напрямую (или зависимость изолирована)?
- **Инварианты**: все ограничения (диапазоны, статусы, права, форматы) проверяются в одном месте, а не “размазаны”?
- **Границы**: на границах системы (`server/api/*`, формы UI) есть валидация и нормализация входов?
- **Имена/структура**: читается без комментариев; нет магических чисел/строк без констант?
- **Тестируемость**: правило можно протестировать без поднятия UI; багфикс сопровождается регрессионным тестом?

## Правила для фич (общий поток)
1) Сформулировать сценарии и бизнес‑правила (что считаем “правильно/неправильно”, какие ограничения).
2) Если меняется модель данных — сначала `prisma/schema.prisma` и миграция.
3) Вынести бизнес‑логику в отдельный модуль/сервис (не в UI и не в `defineEventHandler`).
4) Обновить/добавить API endpoint(ы) в `server/api/`.
5) Подключить UI/состояние (через `composables/`), обработать ошибки и пустые состояния.
6) Написать тесты на новые правила + регрессионный тест на исправление бага.
7) Прогнать чеклист перед PR.

## Правила для `server/api/*` (эндпойнты)
- **Auth/roles**: проверки (`requireAuth/requireAdmin`) — в начале хендлера.
- **Валидация/нормализация**: до обращения к БД (trim, приведение типов, диапазоны, допустимые enum’ы).
- **DTO**: возвращать только то, что нужно клиенту (особенно внимательно к данным пользователя и служебным полям).
- **Коды ошибок**: 400 (валидация), 401 (нет сессии), 403 (нет прав), 404 (не найдено), 409 (конфликт/уникальность).
- **Транзакции**: если меняем несколько сущностей/таблиц — использовать транзакцию (и думать про консистентность).
- **Предсказуемость**: стабильные формы ответов, одинаковые сообщения ошибок для одинаковых причин.

## Правила для Prisma/БД
- Изменения схемы → миграции (в репозитории уже ведётся история в `prisma/migrations/`).
- `prisma/generated/` — генерируемый код: **не редактировать вручную**.
- Предпочитать явные `select/include` (не тянуть “всё” по умолчанию).
- Думать про N+1 и лишние запросы; агрегаты/подсчёты — на стороне БД где уместно.

## Тесты и покрытие бизнес‑логики
Требование: **каждое новое/изменённое бизнес‑правило должно быть покрыто тестом**.

- **Unit**: правила и преобразования (нормализация входов, расчёты, проверки прав, разбор rich‑text и т.п.).
- **Integration**: `server/api/*` на тестовой БД (в идеале отдельная база/схема; очистка данных между тестами).
- **E2E (по мере роста)**: ключевые пользовательские сценарии (логин, покупка/зачисление, прохождение теста и т.д.).

Если тест‑раннер ещё не подключён, рекомендуемый путь для Nuxt: **Vitest** (+ при необходимости `@nuxt/test-utils`) и **Playwright** для e2e.

## Чеклист перед PR
- [ ] `npm run build` проходит.
- [ ] Новая логика не живёт в UI/контроллере, а вынесена и покрыта тестами.
- [ ] Для изменений в БД есть миграция и обновлён seed (если нужен).
- [ ] Валидация входных данных и корректные `statusCode`.
- [ ] Нет утечек приватных данных в ответах API.
- [ ] Нет случайных логов/отладочного кода.
